#!venv/bin/python3

import subprocess
import re
import argparse
from pathlib import Path

project_root = Path("/Users/jessemaitland/PycharmProjects/pandabox")
setup_path = project_root / "setup.py"
version_pattern = "VERSION = '[0-9]+.[0-9]+.[0-9]+'"

commands = {
    '--version': {
        'help': 'OPTIONAL :: use this to explicitly set the version',
        'dest': 'version',
    },
}


def get_arg_parser():
    parser = argparse.ArgumentParser()
    for command, options in commands.items():
        parser.add_argument(command, **options)
    return parser.parse_args()


def validate_version(version):
    if re.search('[0-9]+.[0-9]+.[0-9]+', version):
        return True
    else:
        return False


def run_process(*args):
    process = subprocess.Popen(args=args, stdout=subprocess.PIPE, stderr=subprocess.PIPE, cwd=project_root)
    output, error = process.communicate()

    if error:
        print(error.decode("utf-8"))
        exit()
    else:
        return output, error


def split_output(output):
    return [x for x in output.decode('utf-8').split("\n") if x]


def is_on_master_branch():
    args = ['git', 'branch']
    current_branch = None

    output, error = run_process(*args)
    output = split_output(output)

    for line in output:
        if '*' in line:
            current_branch = line.replace('*', '').strip()

    if current_branch != 'master':
        print(f"current branch is {current_branch}, however you must be on master to deploy!")
        return False

    print("current branch is master")
    return True


def get_last_tag():
    args = ['git', 'tag', '--list']
    output, error = run_process(*args)
    output = split_output(output)

    if output:
        last_tag = output[-1]
    else:
        last_tag = '0.0.1'

    return last_tag


def increment_sub_version(tag):
    tag_parts = tag.split('.')
    tag_parts[-1] = str(int(tag_parts[-1]) + 1)
    tag = '.'.join(tag_parts)
    return tag


def create_git_tag(tag):
    print(f"creating git tag {tag} on master branch")
    args = ['git', 'tag', tag]
    output, error = run_process(*args)
    return True


def set_version_in_setup(tag):
    print(f"updating to version {tag} in setup.py")
    new_version = f"VERSION = '{tag}'"
    setup_py = setup_path.read_text()
    new_setup_py = re.sub(version_pattern, new_version, setup_py)
    setup_path.write_text(new_setup_py)
    print(f"setup.py updated to {new_version}")


def push_git_tag():
    print(f"pushing tags to remote origin")
    args = ['git', 'push', '--tags']
    output, error = run_process(*args)
    print(output)
    return True


def validate_git_tag(tag):
    last_tag = get_last_tag()
    if tag == get_last_tag():
        print(f"git tag {tag} created successfully.")
        return True
    else:
        print(f"error setting git tag. expected tag was {tag}, however current tag is {last_tag}")
        exit()


def main():
    args = get_arg_parser()

    if not is_on_master_branch():
        exit()

    if args.version and validate_version(args.version):
        print(f"version {args.version} valid")
        version = args.version
    else:
        version = get_last_tag()
        version = increment_sub_version(version)

    create_git_tag(version)
    set_version_in_setup(version)
    push_git_tag()


if __name__ == '__main__':
    main()
